# -*- coding: utf-8 -*-
"""EDA.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1hxBvqD7JkrYoxONPOG7VZqqi5YrYlEDj
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.preprocessing import StandardScaler

from google.colab import drive
drive.mount('/content/drive')

!ls /content/drive/MyDrive/visa_project

import pandas as pd

path = "/content/drive/MyDrive/visa_project/data/processed/cleaned_visa_data.csv"  # ðŸ‘ˆ inside quotes!
df = pd.read_csv(path)

print("âœ… Data loaded successfully!")
print(df.head())
print("\nColumns:", df.columns)

df.info()

date_cols = ["APPLICATION_DATE", "DECISION_DATE"]

for col in date_cols:
    df[col] = pd.to_datetime(df[col], errors="coerce")

df.info()

df.describe()

df.isnull().sum()

#Observation:
#Some categorical columns contain missing values. These are not removed
#at this stage, as the objective of EDA is to understand the data rather
#than modify it.

print(df["processing_time_days"].describe())

sns.histplot(df["processing_time_days"], kde=True)
plt.title("Distribution of Visa Processing Days")
plt.xlabel("Processing Days")
plt.ylabel("Count")
plt.show()

plt.figure(figsize=(6,3))
sns.boxplot(x=df["processing_time_days"])
plt.title("Boxplot of Processing Time")
plt.show()

plt.figure(figsize=(7,4))
sns.boxplot(
    x="VISA_CLASS",
    y="processing_time_days",
    data=df
)
plt.xticks(rotation=45)
plt.title("Processing Time by Visa Class (Before FE)")
plt.show()

top_states = df["WORK_STATE"].value_counts().head(10).index
state_df = df[df["WORK_STATE"].isin(top_states)]

plt.figure(figsize=(10, 5))
sns.boxplot(x="WORK_STATE", y="processing_time_days", data=state_df)
plt.title("Processing Time by Top Work States")
plt.show()

plt.figure(figsize=(8, 5))
sns.boxplot(x="CASE_STATUS", y="processing_time_days", data=df)
plt.xticks(rotation=30)
plt.title("Processing Time by Case Status")
plt.show()

### Key Observations

#- Visa processing time shows a right-skewed distribution, indicating
#  the presence of applications with unusually long delays.
#- Certain visa classes exhibit higher median processing times and
 # greater variability.
#- Processing time varies significantly across work states, suggesting
 # regional differences.
#- Case status appears to influence processing duration, with some
 # statuses associated with longer timelines.

#These insights motivate feature selection and modeling decisions
#in the next milestone.

df["COUNTRY_OF_CITIZENSHIP"].isna().sum()

df[df["COUNTRY_OF_CITIZENSHIP"].isna()].head()

df["COUNTRY_OF_CITIZENSHIP"].unique()[:20]

# Feature 1: Application Month
df["application_month"] = df["APPLICATION_DATE"].dt.month
print(df)

corr_matrix = df[["processing_time_days", "application_month"]].corr() # calculates the correlation values
print(corr_matrix)

sns.heatmap(corr_matrix, annot=True, cmap="coolwarm") # annot- shows nos inside the boxes, cmap- color scale for strnegth
plt.title("Correlation Heatmap")
plt.show()

sns.scatterplot(
    x="application_month",
    y="processing_time_days",
    data=df
)
plt.title("Processing Days vs Application Month")
plt.show()

print(df[["APPLICATION_DATE", "application_month"]])

df["APPLICATION_DATE"].dt.year.value_counts()

df["application_year"] = df["APPLICATION_DATE"].dt.year

df["application_year"].head()

df.groupby("application_year")["processing_time_days"].mean()

import matplotlib.pyplot as plt

yearly_avg = df.groupby("application_year")["processing_time_days"].mean()

plt.figure(figsize=(8,4))
yearly_avg.plot(marker='o')
plt.title("Average Processing Time by Year")
plt.ylabel("Days")
plt.show()

#This shows MASSIVE downward trend.
#If you keep raw year values:
#Model may overfit small years
#Noise from 5-row year (2008)

# Feature 2: years_since_start
df["years_since_start"] = (
    df["application_year"] - df["application_year"].min()
)
print(df)

import seaborn as sns
import matplotlib.pyplot as plt

plt.figure(figsize=(6,4))
sns.scatterplot(
    x="years_since_start",
    y="processing_time_days",
    data=df
)
plt.show()

# Feature 3 : Day of Week Feature
# 0 = Monday, 6 = Sunday
# Why this matters:
# Applications submitted on Friday may experience weekend delay.
df["application_dayofweek"] = df["APPLICATION_DATE"].dt.dayofweek
print(df)

# Feature 4: Season (Peak vs Off-Peak)
df["season"]= df["application_month"].apply(
    lambda x: "Peak" if x in [1,2,12] else "off-peak"
) # runs the logic row by row

print(df[["application_month", "season"]])

# Feature 5: Visa Avg Processing Time
visa_avg = df.groupby("VISA_CLASS")["processing_time_days"].mean()
df["visa_avg_processing_time"] = df["VISA_CLASS"].map(visa_avg)
print(visa_avg)

print(df)

# Processing Time vs Application Month (After FE)
plt.figure(figsize=(8,4))
sns.boxplot(
    x="application_month",
    y="processing_time_days",
    data=df
)
plt.title("Processing Time vs Application Month (After FE)")
plt.show()

# Processing Time vs Season (After FE)
plt.figure(figsize=(5,4))
sns.boxplot(
    x="season",
    y="processing_time_days",
    data=df
)
plt.title("Processing Time: Peak vs Off-Peak (After FE)")
plt.show()

plt.figure(figsize=(6,4))
sns.histplot(df["years_since_start"], kde=True)
plt.title("Distribution of years_since_start (After FE)")
plt.show()

# Correlation Heatmap (After FE)

plt.figure(figsize=(6,4))
corr = df[
    [
        "processing_time_days",
        "application_month",
        "years_since_start",
        "visa_avg_processing_time"
    ]
].corr()

sns.heatmap(corr, annot=True, cmap="coolwarm")
plt.title("Correlation Matrix (After Feature Engineering)")
plt.show()

#ENCODING (Categorical â†’ Numerical)

df_encoded = pd.get_dummies(
    df,
    columns=[
        "VISA_CLASS",
        "COUNTRY_OF_CITIZENSHIP",
        "WORK_STATE",
        "CASE_STATUS",
        "season"
    ],
    drop_first=True
)

# SCALING (Numerical Features)

scaler = StandardScaler()

scale_columns = [
    "application_month",
    "years_since_start",
    "visa_avg_processing_time"
]

df_encoded[scale_columns] = scaler.fit_transform(
    df_encoded[scale_columns]
)

df_encoded.shape

df_encoded.head()

df_encoded.to_csv(
    "../content/drive/MyDrive/visa_project/data/processed/final_ml_ready_visa_data.csv",
    index=False
)

print("âœ… Milestone 2 completed. Data is ML-ready.")